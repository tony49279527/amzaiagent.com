<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Your Report | Amz AI Agent</title>
    <meta name="description"
        content="Your Amazon competitor analysis report is being generated. Track real-time progress of the AI agent.">

    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%232563eb%22/><path d=%22M50 20 L20 80 H35 L42 65 H58 L65 80 H80 L50 20 Z M45 58 L50 45 L55 58 H45 Z%22 fill=%22white%22/></svg>">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <meta name="robots" content="noindex">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <span class="logo-text">Amz AI Agent</span>
            </a>
            <!-- Mobile Menu Button -->
            <button class="mobile-menu-btn" aria-label="Toggle Menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="menu-icon-open">
                    <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="menu-icon-close" style="display:none;">
                    <path d="M6 18L18 6M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
            </button>

            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="create.html">Competitor Analysis</a>
                <a href="discovery.html">Product Discovery</a>
                <a href="cases.html">Cases</a>
                <a href="blog.html">Blog</a>
                <a href="pricing.html">Pricing</a>
            </div>
            <div class="nav-actions">
                <a href="create.html" class="btn btn-primary" style="border-radius: 0.375rem;">Start Analysis</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="processing-wrapper">
        <div class="container small-container">

            <!-- 1. Top Status Card -->
            <div class="proc-status-card">
                <!-- ... (existing badge logic) ... -->
                <div id="pro-badge"
                    style="display: none; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: 4px; padding: 4px 12px; font-size: 0.8rem; font-weight: 700; margin-bottom: 1rem; width: fit-content; margin-left: auto; margin-right: auto;">
                    ðŸ’Ž PREMIUM ANALYSIS IN PROGRESS
                </div>
                <div class="proc-header">
                    <div class="status-icon-check">âœ…</div>
                    <div class="header-content">
                        <h1>Submission Successful</h1>
                        <p>We are initiating the AI Agent...</p>
                    </div>
                </div>

                <div class="order-meta-grid">
                    <div class="meta-item">
                        <span class="label">Order ID</span>
                        <span class="value order-id" id="display-order-id">...</span>
                    </div>
                    <div class="meta-item">
                        <span class="label">Email</span>
                        <span class="value" id="display-email">...</span>
                    </div>
                    <div class="meta-item">
                        <span class="label">Status</span>
                        <span class="value" id="realtime-status-text"
                            style="color: #2563eb; font-weight: bold;">Connecting...</span>
                    </div>
                </div>
            </div>

            <!-- NEW: Real-time Agent Terminal -->
            <div class="proc-section">
                <h2 class="section-title">AI Agent Live Log</h2>
                <div id="agent-terminal"
                    style="background: #1e1e2e; border-radius: 12px; padding: 20px; font-family: 'Courier New', monospace; color: #a6accd; height: 300px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 1px solid #313244;">
                    <div
                        style="border-bottom: 1px solid #313244; padding-bottom: 10px; margin-bottom: 15px; display: flex; gap: 8px;">
                        <span style="width: 10px; height: 10px; background: #ff5f56; border-radius: 50%;"></span>
                        <span style="width: 10px; height: 10px; background: #ffbd2e; border-radius: 50%;"></span>
                        <span style="width: 10px; height: 10px; background: #27c93f; border-radius: 50%;"></span>
                        <span style="margin-left: auto; font-size: 0.8rem; opacity: 0.7;">agent@amz-cloud:~</span>
                    </div>
                    <div id="terminal-content" style="font-size: 0.9rem; line-height: 1.6;">
                        <div style="color: #555;">> Initializing secure connection...</div>
                    </div>
                </div>
            </div>

            <!-- 3. What Happens Next -->
            <div class="proc-section">
                <h2 class="section-title">What Happens Next?</h2>
                <div class="next-steps-grid">
                    <div class="next-step-card active" id="card-research">
                        <div class="step-num">01</div>
                        <h3>Deep Research</h3>
                        <p>Agent is browsing Reddit, YouTube, and Amazon for live data.</p>
                    </div>
                    <div class="next-step-card" id="card-analyze">
                        <div class="step-num">02</div>
                        <h3>AI Reasoning</h3>
                        <p>Claude 3.5 Sonnet is analyzing patterns and calculating margins.</p>
                    </div>
                    <div class="next-step-card highlight" id="card-report">
                        <div class="step-num">03</div>
                        <h3 id="step-3-title">Ready!</h3>
                        <p id="step-3-desc">The report will be sent to your email + unlocked here.</p>
                    </div>
                </div>

                <div class="action-row">
                    <!-- Hidden button if reportId is known -->
                    <a href="#" id="preview-btn" class="btn btn-primary"
                        style="display: none; width: 100%; text-align: center;">View Report Now</a>
                </div>
            </div>

            <!-- 4. FAQ -->
            <div class="proc-section">
                <h2 class="section-title">Frequently Asked Questions</h2>
                <div class="proc-faq">
                    <div class="faq-row">
                        <h4>Why does it take 20-50 minutes?</h4>
                        <p>We don't just use a simple template. Our AI agents read hundreds of review pages in real-time
                            to provide up-to-date, authentic market insights.</p>
                    </div>
                    <div class="faq-row">
                        <h4>I haven't received my report yet?</h4>
                        <p>Please check your spam folder first. If it's not there after 30 minutes, contact support at
                            <strong>support@amzaiagent.com</strong> with your Order ID.
                        </p>
                    </div>
                    <div class="faq-row">
                        <h4>Do I have to pay now?</h4>
                        <p>No. You only pay if you are satisfied with the preview and want to unlock the full detailed
                            report.</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-top">
                <h3 class="footer-logo">Amz AI Agent</h3>
                <p class="footer-tagline">AI Amazon Competitor Review Analysis Platform</p>
            </div>
            <!-- Middle: 3 Link Columns -->
            <div class="footer-columns">
                <div class="footer-col">
                    <h4>Product</h4>
                    <a href="create.html">Create Analysis</a>
                    <a href="reports.html">Analysis Reports</a>
                    <a href="pricing.html">Pricing</a>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <a href="blog.html">Blog</a>
                    <a href="cases.html">Case Studies</a>
                    <a href="faq.html">FAQ</a>
                </div>
                <div class="footer-col">
                    <h4>Company</h4>
                    <a href="about.html">About Us</a>
                    <a href="privacy.html">Privacy Policy</a>
                    <a href="terms.html">Terms of Service</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p class="footer-copyright">Â© <script>document.write(new Date().getFullYear())</script> Amz AI Agent. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const email = params.get('email') || localStorage.getItem('pending_email');
            const taskId = params.get('taskId') || params.get('report_id') || localStorage.getItem('pending_task_id');
            const orderId = params.get('orderId') || localStorage.getItem('pending_order_id') || 'ORD-' + (taskId ? taskId.substring(0, 8).toUpperCase() : 'UNKNOWN');

            // 1. Basic Info Populating
            document.getElementById('display-order-id').innerText = orderId;
            document.getElementById('display-email').innerText = email || 'user@example.com';

            // 2. WebSocket Connection / Auto-Trigger
            if (taskId) {
                initWebSocket(taskId);
            } else {
                // Fallback: Check if we have a pending payload from Polar redirect
                const pendingPayload = localStorage.getItem('pending_analysis_payload');
                if (pendingPayload) {
                    triggerPendingAnalysis(JSON.parse(pendingPayload));
                } else {
                    logToTerminal("System", "No Task ID found. Waiting for manual update...");
                }
            }
        });

        let wsRetryCount = 0;
        const WS_MAX_RETRIES = 5;
        let wsCompleted = false;

        function initWebSocket(taskId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const url = protocol + '//' + window.location.host + '/ws/progress/' + taskId;
            const socket = new WebSocket(url);

            socket.onopen = () => {
                wsRetryCount = 0; // Reset on successful connection
                logToTerminal("Network", "Secure connection established.", "#4ade80");
                document.getElementById('realtime-status-text').innerText = "Agent Active";
            };

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);

                // 1. Log to Terminal
                if (msg.details && msg.details.log) {
                    logToTerminal(msg.step, msg.details.log);
                } else {
                    logToTerminal(msg.step, msg.status);
                }

                // 2. Update Status Text
                document.getElementById('realtime-status-text').innerText = `${msg.step}: ${msg.progress}%`;

                // 3. Highlight Cards based on Step
                highlightStep(msg.step);

                // 4. Handle Specific Data (Optional visual candy)
                if (msg.step === 'Amazon Data' && msg.details && msg.details.products) {
                    logToTerminal("System", `Identified ${msg.details.products.length} target products.`, "#facc15");
                }

                // 5. Completion
                if (msg.progress === 100 || msg.step === 'Complete') {
                    wsCompleted = true;
                    handleCompletion(msg.details ? msg.details.report_id : null);
                }
            };

            socket.onclose = () => {
                if (wsCompleted) {
                    logToTerminal("Network", "Connection closed.", "#94a3b8");
                    return;
                }
                // Auto-reconnect with exponential backoff
                if (wsRetryCount < WS_MAX_RETRIES) {
                    wsRetryCount++;
                    const delay = Math.pow(2, wsRetryCount) * 1000; // 2s, 4s, 8s, 16s, 32s
                    logToTerminal("Network", `Connection lost. Reconnecting in ${delay/1000}s... (${wsRetryCount}/${WS_MAX_RETRIES})`, "#f59e0b");
                    setTimeout(() => initWebSocket(taskId), delay);
                } else {
                    logToTerminal("Error", "Unable to reconnect. Please refresh the page.", "#f87171");
                    document.getElementById('realtime-status-text').innerText = "Connection Lost";
                    document.getElementById('realtime-status-text').style.color = "#ef4444";
                }
            };

            socket.onerror = () => {
                // onclose will fire after onerror, reconnection handled there
            };
        }

        function logToTerminal(source, message, color = "#a6accd") {
            const term = document.getElementById('terminal-content');
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            const line = document.createElement('div');
            line.style.cssText = `margin-bottom: 4px; border-left: 2px solid ${color}; padding-left: 8px;`;
            const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
            line.innerHTML = `<span style="opacity: 0.5; font-size: 0.8em;">[${time}]</span> <span style="color: ${color}; font-weight: bold;">${esc(source)}</span> <span>${esc(message)}</span>`;
            term.appendChild(line);
            term.scrollTop = term.scrollHeight;
        }

        function highlightStep(stepName) {
            // Reset all
            document.querySelectorAll('.next-step-card').forEach(el => el.classList.remove('active'));

            if (stepName === 'Web Research') {
                document.getElementById('card-research').classList.add('active');
            } else if (stepName === 'Amazon Data' || stepName === 'AI Analysis') {
                document.getElementById('card-analyze').classList.add('active');
            } else if (stepName === 'Complete') {
                document.getElementById('card-report').classList.add('active');
            }
        }

        function handleCompletion(reportId) {
            document.getElementById('realtime-status-text').innerText = "Completed";
            document.getElementById('realtime-status-text').style.color = "#10b981";

            // Show Button
            const btn = document.getElementById('preview-btn');
            btn.style.display = 'inline-block';
            if (reportId) {
                btn.href = `/api/discovery/report/${reportId}`;
            }
            btn.textContent = "Download Report";
            logToTerminal("System", "Report generated successfully. Check your email.", "#4ade80");
        }
    </script>
</body>

</html>